<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Table</title>

    <style>
        :root {
            --editing-bg-color: #292929;
            /* Define the editing background color */
            --header-select-color: rgba(18, 101, 160, 0.5);
            /* Define new color for header selection */
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
    display: flex;
    flex-direction: column;
    min-height: 100vh; /* Mengisi tinggi layar */
    margin: 0;
    overflow-y: auto;  /* Mengizinkan scroll vertikal jika konten melebihi tinggi layar */
            
        }

        /* Styling untuk membuat layout elemen jadi vertikal */
        .container {
            display: flex;
            flex-direction: column;
            /* Menyusun elemen secara vertikal */
            align-items: center;
            /* Agar elemen berada di tengah secara horizontal */
            padding-bottom: 20px;
            margin-bottom: 20px;


        }
        /* CSS untuk mengelola seluruh layout */
.main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 20px;
}
.group-container {
    display: flex;
    flex-direction: row;
    align-items: center;
    margin-top: 20px;
}
.column {
            display: flex;
            flex-direction: column; /* Elemen di dalam kolom ditumpuk vertikal */
            gap: 10px; /* Jarak antar elemen di dalam kolom */
            width: 50%; /* Setiap kolom mengambil setengah lebar */
        }
        table {
            margin-top: 20px;
            /* Memberi jarak antara judul dan tabel */
            border-collapse: collapse;
            /* Menghilangkan spasi di antara sel-sel */
            width: 100%;
            /* Supaya tabel menyesuaikan lebar */
        }

        th,
        td {
            padding: 12px;
            border: 1px solid #444;
            text-align: left;
            position: relative;
            user-select: none;
            height: 20px; /* Set default height for table cells */

           
            /* Disable text selection */
        }

        th {
    background-color: #3e3e3e;
    cursor: pointer;
    position: relative;
    width: 200px; /* Lebar kolom header tetap 200px */
}

/* Kolom header dengan lebar yang sudah ditentukan */
th#file-name {
    width: 200px;
    cursor: pointer;
    position: relative;
}

th#frame {
    width: 50px;
    cursor: pointer;
    position: relative;
}

th#image {
    width: 100px;
    cursor: pointer;
    position: relative;
}

th#gif {
    width: 100px;
    cursor: pointer;
    position: relative;
}

        .vertical-line {
            position: absolute;
            width: 2px;
            background-color: blue;
            top: 0;
            bottom: 0;
            /* Membuat garis memanjang hingga ke bawah tabel */
            display: none;
            /* Sembunyikan garis secara default */
            pointer-events: none;
            /* Agar tidak menghalangi drag */
        }

        th:hover .drag-indicator {
            opacity: 1;
            /* Make the indicator visible on hover */
        }

        .drag-indicator {
            position: absolute;
            top: 3px;
            /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background-color: #b3b3b3;
            border-radius: 10px;
            opacity: 0;
            /* Initially hidden */
            transition: opacity 0.3s ease;
        }

        th:hover {
            background-color: #505050;
            /* Fill for header hover */
        }

        th.selected {
            
            background-color: var(--header-select-color);
            /* New color for header selection */
        }

        .dragging-box {
            position: absolute;
            background-color: rgba(0, 123, 255, 0.3);
            /* Warna transparan */
            border: 2px dashed rgba(0, 123, 255, 0.5);
            /* Border yang sedikit lebih gelap */
            display: none;
            /* Sembunyikan box secara default */
            pointer-events: none;
            /* Tidak dapat berinteraksi */
        }

        th.selected .drag-indicator {
            background-color: #52bdff;
            /* Change color when column is selected */
            opacity: 1;
            /* Ensure visibility */
        }

        th.selected:hover .drag-indicator {
            opacity: 1;
            /* Keep indicator visible when selected */
        }

        .editing {
            background-color: var(--editing-bg-color);
            /* Use the variable */
            transition: background-color 0.3s ease;
        }

        td.editing:hover,
        th.editing:hover {
            outline: none;
            /* Disable hover effect when editing */
            background-color: var(--editing-bg-color);
            /* Use the variable */
        }

        th.selected.editing,
        th.selected.editing:hover {
            background-color: var(--editing-bg-color);
            /* Keep the edit background color */
            cursor: default;
            /* Change cursor to default */
        }

        td:hover {
            outline: 1px solid rgb(138, 138, 138);
            /* Outline for content hover */
        }

        .selected {
            outline: 1px solid #0072ba !important;
            /* Blue outline for selected */
        }

        .highlight {
            background-color: rgba(28, 96, 138, 0.212);
            /* Light blue fill during drag */
        }

        /*#0072BA*/

        .outline {
            border: 2px solid #068ee2;
        }

        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            user-select: none;
        }

        .new-row {
            width: 100%;
            /* Full width */
            height: 40px;
            text-align: left;
            /* Align text to the left */
            padding-left: 20px;
            /* Add some padding to the left */
            cursor: pointer;
            color: white;
            background-color: transparent;
            opacity: 1;
            transition: background-color 0.3s ease, border-radius 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            position: relative;
        }

        .new-row::before {
            content: "+";
            position: absolute;
            color: #636363;
        }

        .new-row:hover {
            background-color: #383838;
            /* Darker grey */
            border-radius: 8px;
            /* Rounded cornerss */
        }

        .new-row:hover::before {
            content: "+ New";
            color: #b0b0b0;
            /* Lighter grey text */
            transition: color 0.3s ease;
        }


        input {
            width: 100%;
            border: none;
            background-color: transparent;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            box-sizing: border-box;
            outline: none;
            height: 100%;
            /* Maintain consistent height */
            padding: 0;
            /* Ensure no padding */
            margin: 0;
            /* Ensure no margin */
            line-height: normal;
            /* Normalize line-height */
        }
        .drop-zone {
    border: 2px dashed #ccc;
    padding: 20px;
    text-align: center;
    cursor: pointer;
}
.upload-btn {
    margin-top: 10px;
}
.modal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
}
.modal img {
    max-width: 100%;
    max-height: 80vh;
}
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

        /* Popup hijau untuk keberhasilan */
        .popup.success {
            background-color: #4CAF50; /* Hijau */
            color: white;
        }
/* Popup oranye untuk sebagian berhasil */
.popup.warning {
    background-color: orange; /* Oranye */
    color: white;
}

        /* Popup merah untuk kegagalan */
        .popup.error {
            background-color: rgb(156, 53, 53); /* Merah */
            color: white;
        }

        /* Popup default */
        .popup {
            display: none; /* Awalnya tersembunyi */
            position: fixed; /* Tetap berada di posisi layar */
            bottom: 20px; /* Jarak dari bagian bawah layar */
            left: 50%; /* Pusatkan secara horizontal */
            transform: translateX(-50%); /* Atur posisi ke tengah */
            padding: 15px 20px; /* Spasi dalam popup */
            border-radius: 8px; /* Sudut melengkung */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Efek bayangan */
            z-index: 1000; /* Pastikan berada di atas elemen lain */
            font-size: 16px; /* Ukuran teks */
            text-align: center; /* Pusatkan teks */
            animation: fadeInOut 6s ease-in-out; /* Animasi muncul dan menghilang */
        }

        /* Animasi popup muncul dan menghilang */
        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px); /* Bergerak sedikit ke bawah */
            }
            10% {
                opacity: 1;
                transform: translateX(-50%) translateY(0); /* Tetap */
            }
            90% {
                opacity: 1;
                transform: translateX(-50%) translateY(0); /* Tetap */
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px); /* Fade-out dengan gerakan */
            }
        }


        .table-wrapper {
    width: 100%;
    overflow-x: auto; /* Untuk scroll horizontal jika tabel lebih lebar */
}


/* Gaya untuk kontainer gambar yang memiliki posisi relatif */
.image-container {
    position: relative;
    display: inline-block; /* atau flex, sesuai dengan kebutuhan */
}

/* Gaya untuk spinner */
.spinner {
    border: 3px solid #f3f3f3; /* warna latar belakang spinner */
    border-top: 3px solid #3498db; /* warna spinner */
    border-radius: 50%;
    width: 50px; /* ukuran spinner */
    height: 50px; /* ukuran spinner */
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Memindahkan spinner tepat di tengah */
    animation: spin 1s linear infinite; /* Animasi untuk membuat spinner berputar */
}

/* Animasi untuk spinner berputar */
@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Gambar yang sedang diupload akan diberikan transparansi */
.uploaded-img {
    width: 100px;
    opacity: 1; /* Efek transparansi saat upload */
    transition: opacity 0.3s ease-in-out;
}



    </style>




















</head>

<body>
    <!-- Div pembungkus untuk grup Cloudinary dan tabel -->
    <div class="main-container">
        <!-- Grup Cloudinary -->
        <div class="group-container">
            <!-- Kolom Select Shotlist -->
            <div class="column">
                <h3>Select Shotlist</h3>
                <input type="file" id="fileInputShotlist" accept=".txt">
            </div>
    
            <!-- Kolom Select Image -->
            <div class="column">
                <h3>Select Image</h3>
                <input type="file" id="fileInputImage" accept="image/*" multiple disabled>
                <div id="popupNotification" class="popup">Pesan popup di sini!</div>
            </div>
        </div>

        <!-- Tabel Dinamis -->
        <div class="container">
            <br></br>
            <h2>Dynamic Table</h2>
            <h2 id="totalShots">Total Shots: 0</h2>
            <table id="dynamicTable">
                <thead>
                    <tr>
                        <th id="file-name">
                            File Name
                            <div class="resizer"></div>
                            <div class="drag-indicator"></div>
                        </th>
                        <th id="frame">
                            Frame
                            <div class="resizer"></div>
                            <div class="drag-indicator"></div>
                        </th>
                        <th id="image">
                            Image
                            <div class="resizer"></div>
                            <div class="drag-indicator"></div>
                        </th>
                        <th id="gif">
                            GIF
                            <div class="resizer"></div>
                            <div class="drag-indicator"></div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Existing rows go here -->
                </tbody>
            </table>
            <div class="new-row" onclick="addNewRow()">+</div>
        </div>
    </div>






    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getFirestore, getDocs, collection, doc, updateDoc, deleteDoc, deleteField, addDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyCDYpb06iCoZcq7hQ-I4nKYy5mUqfda4x8",
            authDomain: "test-project-b15a3.firebaseapp.com",
            projectId: "test-project-b15a3",
            storageBucket: "test-project-b15a3.appspot.com",
            messagingSenderId: "657486131512",
            appId: "1:657486131512:web:849f099898f428b00211cd",
            measurementId: "G-Z8Z30YVMWB"
        };
    
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);






        async function loadDataFromFirestore() {
    const querySnapshot = await getDocs(collection(db, 'your_collection'));
    clearTable(); // Bersihkan tabel sebelum mengimpor data baru

    querySnapshot.forEach((doc) => {
        const data = doc.data();
        const row = document.createElement('tr');
        row.setAttribute('data-id', doc.id);

        // Buat sel untuk setiap kolom
        for (let i = 0; i < table.rows[0].cells.length; i++) {
            const cell = document.createElement('td');
            switch (table.rows[0].cells[i].id) {
                case 'file-name':
                    cell.textContent = data.fileName || '';
                    break;
                case 'frame':
                    cell.textContent = data.frame || '';
                    break;
                case 'image':
                    if (data.image) {
                        const img = document.createElement('img');
                        img.src = data.image;  // Ambil dari field image
                        img.alt = data.fileName;
                        img.classList.add('uploaded-img');
                        cell.appendChild(img);

                        // Add event listener for preview
                        img.addEventListener('click', () => {
                            const modal = document.querySelector('.modal img');
                            modal.src = img.src;
                            document.querySelector('.modal-overlay').style.display = 'block';
                            document.querySelector('.modal').style.display = 'block';
                        });
                    }
                    break;
                case 'gif':
                    if (data.gif) {
                        const img = document.createElement('img');
                        img.src = data.gif;  // Ambil dari field gif
                        img.alt = data.fileName;
                        img.classList.add('uploaded-img');
                        cell.appendChild(img);

                        // Add event listener for preview
                        img.addEventListener('click', () => {
                            const modal = document.querySelector('.modal img');
                            modal.src = img.src;
                            document.querySelector('.modal-overlay').style.display = 'block';
                            document.querySelector('.modal').style.display = 'block';
                        });
                    }
                    break;
            }
            row.appendChild(cell);
        }
        tableBody.appendChild(row);
    });
    updateTotalShots(); // Update total shots setelah data dimuat
}


document.addEventListener('DOMContentLoaded', function () {
    loadDataFromFirestore();
});


function clearTable() {
    // Menghapus semua row di tabel HTML
    const tableBody = document.querySelector('#dynamicTable tbody');
    const rows = Array.from(tableBody.querySelectorAll('tr')); // Ambil semua baris di tabel

    // Loop untuk menghapus data berdasarkan ID baris dalam tabel
    rows.forEach(async (row) => {
        const docId = row.getAttribute('data-id');  // Ambil ID dokumen yang ada di atribut data-id
        
        if (docId) {
            try {
                await deleteDoc(doc(db, 'your_collection', docId)); // Menghapus dokumen berdasarkan ID
                console.log(`Dokumen dengan ID ${docId} telah dihapus dari Firestore.`);
                // Setelah dokumen dihapus, Anda bisa menghapus baris di tabel juga
                row.remove();
            } catch (error) {
                console.error(`Gagal menghapus dokumen dengan ID ${docId}:`, error);
            }
        }
    });

    // Update total shots setelah data dihapus
    updateTotalShots();
}


function updateTotalShots() {
    const totalShotsElement = document.getElementById('totalShots');
    const totalRows = tableBody.querySelectorAll('tr').length;
    totalShotsElement.textContent = `Total Shots: ${totalRows}`;
}






    // Modal untuk menampilkan gambar
    const modalOverlay = document.createElement('div');
    modalOverlay.classList.add('modal-overlay');
    const modal = document.createElement('div');
    modal.classList.add('modal');
    modal.innerHTML = `<img src="" alt="Image Preview">`;
    document.body.appendChild(modalOverlay);
    document.body.appendChild(modal);

    modalOverlay.addEventListener('click', () => {
        modalOverlay.style.display = 'none';
        modal.style.display = 'none';
    });

function getColumnIndex(id) {
    const headers = Array.from(document.querySelectorAll('thead th')); // Ubah selector sesuai tabel Anda
    return headers.findIndex(th => th.id === id);
}



            const fileNameColumnIndex = getColumnIndex('file-name');
            console.log('File Name Column Index:', fileNameColumnIndex);



function showPopup(message, type) {
    const popup = document.getElementById('popupNotification');
    popup.textContent = message;
    
    // Menentukan warna popup berdasarkan jenis (type)
    if (type === 'success') {
        popup.className = 'popup success';  // Hijau untuk sukses
    } else if (type === 'warning') {
        popup.className = 'popup warning';  // Oranye untuk sebagian berhasil
    } else if (type === 'error') {
        popup.className = 'popup error';  // Merah untuk gagal
    }
    
    popup.style.display = 'block';

    // Hilangkan popup setelah 6 detik
    setTimeout(() => {
        popup.style.display = 'none';
    }, 6000);
}





const fileInputShotlist = document.getElementById('fileInputShotlist');
const fileInputImage = document.getElementById('fileInputImage');
const tableBody = document.querySelector('#dynamicTable tbody');
const popupNotification = document.getElementById('popupNotification');
let shotlistFilenames = new Set(); // Menyimpan nama file dari shotlist

async function updateRowInFirestore(docId, data) {
    try {
        const docRef = doc(db, 'your_collection', docId);
        await updateDoc(docRef, data);
        console.log('Document updated with ID: ', docId);
    } catch (e) {
        console.error('Error updating document: ', e);
    }
}

document.getElementById('fileInputImage').addEventListener('change', async function (event) {
    const files = Array.from(event.target.files);
    const rows = Array.from(document.querySelectorAll('#dynamicTable tbody tr'));

    const fileNameColumnIndex = getColumnIndex('file-name');
    const gifColumnIndex = getColumnIndex('gif');
    const imageColumnIndex = getColumnIndex('image');

    let successCount = 0;
    let failedCount = 0;

    for (const file of files) {
        const fileNameWithoutExtension = file.name.split('.')[0];
        const fileExtension = file.name.split('.').pop().toLowerCase();
        const fieldName = (fileExtension === 'gif') ? 'gif' : 'image'; // Tentukan field yang benar

        const matchedRow = rows.find(row =>
            row.cells[fileNameColumnIndex].textContent.trim() === fileNameWithoutExtension
        );

        if (matchedRow) {
            successCount++;
            const targetColumnIndex = fileExtension === 'gif' ? gifColumnIndex : imageColumnIndex;
            const targetCell = matchedRow.cells[targetColumnIndex];
            targetCell.innerHTML = '';

            const imageContainer = document.createElement('div');
            imageContainer.classList.add('image-container');

            const spinner = document.createElement('div');
            spinner.classList.add('spinner');

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.alt = fileNameWithoutExtension;
            img.classList.add('uploaded-img');
            img.style.cursor = 'pointer';

            imageContainer.appendChild(spinner);
            imageContainer.appendChild(img);
            targetCell.appendChild(imageContainer);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', 'osxiczbn');

            try {
                const response = await fetch('https://api.cloudinary.com/v1_1/daa1hi5nb/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data && data.secure_url) {
                    img.src = data.secure_url;
                    img.style.opacity = '1';
                    spinner.remove();

                    img.addEventListener('click', () => {
                        const modal = document.querySelector('.modal img');
                        modal.src = img.src;
                        document.querySelector('.modal-overlay').style.display = 'block';
                        document.querySelector('.modal').style.display = 'block';
                    });

                    const docId = matchedRow.getAttribute('data-id');
                    console.log('Updating document with ID:', docId);
                    await updateRowInFirestore(docId, { [fieldName]: data.secure_url });
                } else {
                    spinner.style.background = 'conic-gradient(#e74c3c 100%, #f3f3f3 0%)';
                    failedCount++;
                }
            } catch (error) {
                spinner.style.background = 'conic-gradient(#e74c3c 100%, #f3f3f3 0%)';
                failedCount++;
                console.error('Upload error:', error);
            }
        } else {
            failedCount++;
        }
    }

    if (successCount > 0 && failedCount === 0) {
        showPopup(`${successCount} file berhasil diunggah!`, 'success');
    } else if (successCount > 0 && failedCount > 0) {
        showPopup(`${successCount} file berhasil, ${failedCount} file gagal.`, 'warning');
    } else {
        showPopup('Tidak ada file yang cocok dengan shotlist!', 'error');
    }
});
















fileInputShotlist.addEventListener('change', function (event) {
    const file = event.target.files[0];
    if (!file) {
        showPopup('Tidak ada file yang dipilih!', 'error');
        return;
    }

    const fileNameColumnIndex = getColumnIndex('file-name');
    const frameColumnIndex = getColumnIndex('frame');

    const reader = new FileReader();
    reader.onload = async function (e) {
        const content = e.target.result;
        const lines = content.split('\n');
        shotlistFilenames.clear();

        clearTable();

        let successCount = 0;
        let failedCount = 0;

        for (const line of lines) {
            const [filename, frame] = line.split('\t').map(item => item.trim());

            if (filename && frame) {
                shotlistFilenames.add(filename);

                // Tambahkan baris baru ke tabel
                const row = document.createElement('tr');
                row.setAttribute('data-id', ''); // Placeholder untuk ID dokumen Firestore

                for (let i = 0; i < table.rows[0].cells.length; i++) {
                    const cell = document.createElement('td');
                    if (i === fileNameColumnIndex) {
                        cell.textContent = filename;
                    } else if (i === frameColumnIndex) {
                        cell.textContent = frame;
                    }
                    row.appendChild(cell);
                }

                // Simpan data ke Firestore dan dapatkan ID dokumen
                try {
                    const docRef = await addDoc(collection(db, 'your_collection'), {
                        fileName: filename,
                        frame: frame,
                        gif: '',
                        image: ''
                    });
                    row.setAttribute('data-id', docRef.id); // Simpan ID dokumen
                    successCount++;
                } catch (error) {
                    console.error('Error adding document: ', error);
                    failedCount++;
                }

                tableBody.appendChild(row);
            } else {
                failedCount++;
            }
        }

        if (successCount > 0 && failedCount > 0) {
            showPopup(`${successCount} shotlist berhasil diimpor, ${failedCount} gagal diimpor.`, 'warning');
        } else if (successCount > 0 && failedCount === 0) {
            showPopup(`${successCount} shotlist berhasil diimpor!`, 'success');
        } else if (successCount === 0 && failedCount > 0) {
            showPopup('Semua shotlist gagal diimpor. Pastikan format file benar!', 'error');
        }

        if (successCount > 0) {
            fileInputImage.disabled = false;
        }
        updateTotalShots();
    };

    reader.onerror = () => showPopup('Gagal membaca file!', 'error');
    reader.readAsText(file);
});















        const table = document.getElementById('dynamicTable');
        

        let isDragging = false; // Flag untuk mendeteksi proses dragging
        let isResizing = false; // Global flag to detect if resizing is in progress
        let selectedCells = [];
        let copiedData = null; // Tempat menyimpan data yang disalin

// Listener untuk klik pada tabel
table.addEventListener('dblclick', (e) => {
    const cell = e.target.closest('td');
    if (!cell || cell.cellIndex === 2) return; // Abaikan kolom gambar
    editField(cell);
});




        table.addEventListener('mousedown', function (event) {
    const target = event.target;

    if (target.tagName === 'TH') {
        // Klik pada header kolom
        const colIndex = target.cellIndex;
        clearSelection();
        selectColumn(colIndex);
        target.classList.add('selected'); // Apply selected style to header
        target.classList.remove('hover'); // Remove hover effect
    } else if (target.tagName === 'TD') {
        // Klik pada cell biasa
        clearSelection();
        target.classList.add('outline');
        selectedCells = [target];

        const startCell = target;
        const startCol = startCell.cellIndex;
        const startRow = startCell.parentElement.rowIndex;

        const selectCells = (startCol, startRow, endCol, endRow) => {
            clearSelection();
            selectedCells = [];
            for (let row = Math.min(startRow, endRow); row <= Math.max(startRow, endRow); row++) {
                for (let col = Math.min(startCol, endCol); col <= Math.max(startCol, endCol); col++) {
                    const cell = table.rows[row]?.cells[col];
                    if (cell) {
                        cell.classList.add('highlight');
                        selectedCells.push(cell);
                    }
                }
            }
            startCell.classList.add('outline');
        };

        const onMouseMove = (event) => {
            const cell = document.elementFromPoint(event.pageX, event.pageY)?.closest('td');
            if (cell) {
                selectCells(startCol, startRow, cell.cellIndex, cell.parentElement.rowIndex);
            }
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener(
            'mouseup',
            function () {
                document.removeEventListener('mousemove', onMouseMove);
                console.log('Selected cells:', selectedCells);
            },
            { once: true }
        );
    }
});

// Seleksi semua baris di kolom
function selectColumn(colIndex) {
    selectedCells = [];
    for (let row of table.rows) {
        const cell = row.cells[colIndex];
        if (cell) {
            cell.classList.add('highlight');
            selectedCells.push(cell);
        }
    }
}


        function clearSelection() {
            const selected = document.querySelectorAll('.selected, .outline, .highlight');
            selected.forEach(cell => {
                cell.classList.remove('selected', 'outline', 'highlight');
            });
            selectedCells = []; // Reset array selectedCells
        }


        document.addEventListener('copy', (event) => {
    if (selectedCells.length > 0) {
        let dataMatrix = [];

        selectedCells.forEach(cell => {
            const parentRow = cell.parentElement;
            if (parentRow.parentElement.tagName !== 'TBODY') return; // Abaikan header

            const rowIndex = parentRow.rowIndex - 1; // Sesuaikan indeks tbody
            const colIndex = cell.cellIndex;

            if (!dataMatrix[rowIndex]) {
                dataMatrix[rowIndex] = [];
            }

            // Cek apakah sel berisi gambar
            const img = cell.querySelector('img');
            if (img) {
                // Jika ada gambar, simpan URL gambar
                dataMatrix[rowIndex][colIndex] = img.src;
            } else {
                // Jika bukan gambar, simpan teks biasa
                dataMatrix[rowIndex][colIndex] = cell.textContent.trim();
            }
        });

        // Log untuk memeriksa dataMatrix
        console.log('Data Matrix:', dataMatrix);

        const copiedData = dataMatrix
            .filter(Boolean) // Hapus baris kosong
            .map(row => row.filter(Boolean).join('\t')) // Gabungkan kolom per baris
            .join('\n'); // Gabungkan baris dengan newline

        console.log('Copied Data:', copiedData); // Debug hasil data

        try {
            // Mengatur data yang akan disalin ke clipboard
            event.clipboardData.setData('text/plain', copiedData);
            event.preventDefault(); // Prevent default behavior
            console.log('Data copied to clipboard');
        } catch (error) {
            console.error('Error copying data:', error);
        }
    } else {
        console.log('No cells selected to copy');
    }
});







// Add the isEditMode function
function isEditMode() {
    return !!document.querySelector('.editing'); // Checks if any cell has the 'editing' class
}

document.addEventListener('paste', async (event) => {
    if (selectedCells.length > 0  && !isEditMode) {
        const clipboardData = await navigator.clipboard.readText();
        const rowsData = clipboardData.split('\n').map(row => row.split('\t'));
        const startCell = selectedCells[0];
        const startRow = startCell.parentElement.rowIndex;
        const startCol = startCell.cellIndex;
        let newRowsAdded = [];
        
        rowsData.forEach((rowData, rowIndex) => {
            const targetRow = startRow + rowIndex;
            
            if (targetRow >= table.rows.length) {
                addNewRow();
                newRowsAdded.push(targetRow);
            }
            
            const currentRow = table.rows[targetRow];
            
            rowData.forEach((cellData, colIndex) => {
                const targetCol = startCol + colIndex;
                
                if (targetCol < currentRow.cells.length && cellData !== undefined) {
                    const targetCell = currentRow.cells[targetCol];
                    targetCell.textContent = cellData;
                    targetCell.classList.add('highlight');
                }
            });
        });
        
        newRowsAdded.forEach(rowIndex => {
            const newRow = table.rows[rowIndex];
            for (let col = startCol; col < startCol + rowsData[0].length; col++) {
                if (newRow.cells[col]) {
                    newRow.cells[col].classList.add('highlight');
                }
            }
        });
        
        event.preventDefault();
        selectedCells = [];
    }
});




function addNewRow() {
    const newRow = document.createElement('tr');
    const columns = table.rows[0].cells.length; // Ambil jumlah kolom dari header tabel
    for (let i = 0; i < columns; i++) {
        const newCell = document.createElement('td');
        newCell.textContent = ''; // Isi default untuk sel baru
        newRow.appendChild(newCell);
    }
    table.tBodies[0].appendChild(newRow); // Tambahkan baris baru ke tabel
    clearSelection()
}



document.addEventListener('paste', async (event) => {
    if (selectedCells.length > 0) {
        const clipboardData = await navigator.clipboard.readText();
        const rowsData = clipboardData.split('\n').map(row => row.split('\t'));

        const startCell = selectedCells[0];
        const startRow = startCell.parentElement.rowIndex;
        const startCol = startCell.cellIndex;

        rowsData.forEach((rowData, rowIndex) => {
            let targetRow = startRow + rowIndex;

            // Tambahkan baris baru jika baris target melebihi jumlah baris yang ada
            if (targetRow >= table.rows.length) {
                addNewRow(); // Fungsi untuk menambah baris baru
            }

            rowData.forEach((cellData, colIndex) => {
                const targetCol = startCol + colIndex;
                const targetCell = table.rows[targetRow].cells[targetCol];
                if (targetCell && cellData !== undefined) {
                    targetCell.textContent = cellData; // Tempelkan data ke sel
                }
            });
        });

        event.preventDefault();
        selectedCells = [];
    }
});



    // Contoh pemilihan sel untuk ditempelkan data
    document.querySelectorAll('td').forEach(cell => {
        cell.addEventListener('click', () => {
            selectCell(cell); // Pilih sel saat diklik
        });
    });




    document.addEventListener('keydown', async (event) => {
    if ((event.key === 'Delete' || event.key === 'Backspace') && selectedCells.length > 0) {
        // Loop untuk setiap sel yang dipilih
        for (const cell of selectedCells) {
            // Cek apakah sel memiliki atribut data-field dan data-id
            const fieldName = cell.getAttribute('data-field'); // Ambil nama field (misalnya 'image', 'gif')
            const row = cell.closest('tr');  // Ambil baris yang berisi sel
            const docId = row ? row.getAttribute('data-id') : null;  // Ambil docId dari atribut data-id pada baris

            // Cek apakah fieldName dan docId ada
            if (docId && fieldName) {
                try {
                    // Menghapus field dari dokumen Firestore berdasarkan docId dan fieldName
                    const docRef = doc(db, 'your_collection', docId);
                    await updateDoc(docRef, {
                        [fieldName]: deleteField() // Menghapus field
                    });
                    console.log(`Field ${fieldName} di dokumen dengan ID ${docId} telah dihapus.`);

                    // Hapus konten sel di tabel HTML
                    cell.textContent = ''; // Hapus konten sel
                } catch (error) {
                    console.error(`Gagal menghapus field ${fieldName} pada dokumen dengan ID ${docId}:`, error);
                }
            } else {
                console.log('Field atau docId tidak ditemukan');
            }
        }

        // Prevent default delete behavior pada browser (misalnya, menghapus teks dari form input)
        event.preventDefault();
    }
});









        function editField(cell) {
    // Abaikan kolom gambar
    if (cell.cellIndex === 2) return; // Kolom gambar ada di indeks 2

    const currentText = cell.textContent;
    const input = document.createElement('input');
    input.value = currentText.trim();
    input.style.width = 'calc(100% - 10px)';
    input.style.height = 'calc(100% - 10px)';
    input.style.boxSizing = 'border-box';
    input.style.position = 'absolute';
    input.style.top = '5px';
    input.style.left = '5px';
    input.style.zIndex = '1000';
    input.style.padding = '5px';

    // Simpan elemen-elemen penting
    const existingContent = Array.from(cell.childNodes); // Simpan salinan
    const resizer = cell.querySelector('.resizer');
    const dragZone = cell.querySelector('.drag-zone');

    // Kosongkan sel tanpa menghapus elemen penting
    for (const node of [...cell.childNodes]) { // Salinan baru untuk mencegah konflik
        if (node !== resizer && node !== dragZone) {
            cell.removeChild(node);
        }
    }

    // Tambahkan input dan elemen penting kembali
    cell.appendChild(input);
    if (resizer) cell.appendChild(resizer);
    if (dragZone) cell.appendChild(dragZone);

    cell.style.position = 'relative';
    cell.classList.add('editing');
    input.focus();

    function exitEditMode() {
        cell.classList.remove('editing');
        if (cell.contains(input)) {
            cell.removeChild(input);
        }

        // Kembalikan konten asli
        existingContent.forEach(node => {
            if (node !== input && node !== resizer && node !== dragZone) {
                cell.appendChild(node.cloneNode(true));
            }
        });

        // Update teks
        const textNode = Array.from(cell.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
        if (textNode) {
            textNode.nodeValue = input.value;
        } else {
            cell.insertBefore(document.createTextNode(input.value), cell.firstChild);
        }

        // Pastikan elemen penting tetap ada
        if (resizer && !cell.contains(resizer)) cell.appendChild(resizer);
        if (dragZone && !cell.contains(dragZone)) cell.appendChild(dragZone);

        document.removeEventListener('click', outsideClickListener);
    }

    function outsideClickListener(event) {
        if (!cell.contains(event.target) && event.target !== input) {
            exitEditMode();
        }
    }

    input.addEventListener('blur', exitEditMode);
    input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            exitEditMode();
        }
    });

    document.addEventListener('click', outsideClickListener);
}
















        function makeColumnsDraggable() {
            const table = document.getElementById('dynamicTable');
            const verticalLine = document.createElement('div');
            verticalLine.classList.add('vertical-line');
            document.body.appendChild(verticalLine);

            // Box untuk menampilkan area drag
            const draggingBox = document.createElement('div');
            draggingBox.classList.add('dragging-box');
            document.body.appendChild(draggingBox);
            draggingBox.style.display = 'none'; // Sembunyikan saat tidak digunakan


            let draggedColId = null;
            let targetId = null;
            let isDragging = false;

            // Memastikan setiap kolom memiliki ID unik
            table.querySelectorAll('th').forEach((th, index) => {
                if (!th.id) {
                    th.id = `col-${index}`;
                }
            });

            table.querySelectorAll('th').forEach((th) => {
                const dragZone = document.createElement('div');
                dragZone.className = 'drag-zone';
                dragZone.style.height = '5px';
                dragZone.style.width = '100%';
                dragZone.style.position = 'absolute';
                dragZone.style.top = '0';
                dragZone.style.left = '0';
                dragZone.style.cursor = 'grab';
                th.style.position = 'relative';
                th.appendChild(dragZone);

                dragZone.setAttribute('draggable', true);



                dragZone.addEventListener('dragstart', (e) => {
                    isDragging = true;
                    draggedColId = th.id;
                    e.dataTransfer.effectAllowed = 'move';

                    // Hilangkan seleksi (outline biru), highlight, dan class 'selected' dari semua cell dan header yang sebelumnya diseleksi
                    let previouslySelectedCells = document.querySelectorAll('.outline, .selected, .highlight');
                    previouslySelectedCells.forEach(cell => {
                        cell.classList.remove('outline', 'highlight', 'selected'); // Hapus semua class seleksi dan highlight
                    });

                    // Seleksi header yang sedang di-drag
                    th.classList.add('selected'); // Tambahkan class 'selected' ke header

                    // Seleksi seluruh kolom beserta baris di bawahnya
                    let table = document.querySelector('table'); // Asumsikan kamu menggunakan tabel
                    let colIndex = th.cellIndex; // Mendapatkan index kolom dari header

                    // Ambil semua baris dan highlight cell yang ada di kolom yang sama
                    Array.from(table.rows).forEach(row => {
                        let cell = row.cells[colIndex];
                        if (cell) {
                            cell.classList.add('highlight'); // Tambahkan class 'highlight' ke semua cell di kolom yang sama
                        }
                    });
                    // Ambil nama kolom yang sedang di-drag
                    // Ambil tinggi dari baris kedua (baris pertama adalah header)
                    const rowHeight = table.rows[0].offsetHeight; // Ambil tinggi dari baris pertama setelah header
                    const headerHeight = table.rows[0].offsetHeight; // Ambil tinggi dari header

                    // Mengatur konten box dragging
                    const columnName = table.rows[0].cells[th.cellIndex].textContent; // Ambil nama kolom



                    draggingBox.innerHTML = `
    <div style="text-align: center; font-weight: bold; margin: 10px 0;color: rgba(150, 150, 150, 0.8);">${columnName}</div>
    <table style="width: 100%; border-collapse: collapse;">
        <tbody>
            ${Array.from(table.rows).map(row => `
                <tr style="height: ${rowHeight}px; background-color: rgba(40, 40, 40, 0.4);">
                    <td </td>
                </tr>`).slice(1).join('')} <!-- Mulai dari baris kedua untuk menghindari header -->
        </tbody>
    </table>
`;



                });





                th.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!isDragging) return;
                    e.dataTransfer.dropEffect = 'move';

                    const rect = th.getBoundingClientRect();
                    const halfway = rect.left + rect.width / 2;

                    if (e.clientX < halfway) {
                        targetId = th.id;
                        verticalLine.style.left = `${rect.left}px`;
                    } else {
                        const nextTh = th.nextElementSibling;
                        targetId = nextTh ? nextTh.id : 'end';
                        verticalLine.style.left = `${rect.right}px`;
                    }

                    verticalLine.style.top = `${table.getBoundingClientRect().top}px`;
                    verticalLine.style.height = `${table.getBoundingClientRect().height}px`;
                    verticalLine.style.display = 'block';
                    // Ambil posisi kursor

                    // Menentukan posisi box dragging


                    // Menentukan posisi box dragging

                    draggingBox.style.width = `${rect.width}px`;
                    draggingBox.style.height = `${table.getBoundingClientRect().height}px`;
                    draggingBox.style.left = `${e.clientX}px`;
                    draggingBox.style.top = `${table.getBoundingClientRect().top}px`;
                    draggingBox.style.display = 'block'; // Tampilkan box dragging
                    draggingBox.style.backgroundColor = 'rgba(60, 60, 60, 0.7)'; // Warna merah

                });


                th.addEventListener('drop', (e) => {
                    e.preventDefault();
                    isDragging = false;
                    verticalLine.style.display = 'none';

                    if (draggedColId !== null && targetId !== null && draggedColId !== targetId) {
                        moveColumn(draggedColId, targetId);
                    }
                });

                th.addEventListener('dragend', () => {
                    isDragging = false;
                    verticalLine.style.display = 'none';
                    draggingBox.style.display = 'none'; // Sembunyikan box saat drag selesai

                });
            });

            function moveColumn(fromId, toId) {
                const rows = Array.from(table.rows);
                const fromIndex = getColumnIndex(fromId);
                const toIndex = toId === 'end' ? rows[0].cells.length : getColumnIndex(toId);

                rows.forEach(row => {
                    const fromCell = row.cells[fromIndex];
                    row.removeChild(fromCell);
                    if (toId === 'end') {
                        row.appendChild(fromCell);
                    } else {
                        const toCell = row.cells[toIndex > fromIndex ? toIndex - 1 : toIndex];
                        row.insertBefore(fromCell, toCell);
                    }
                });

                // Reset drag state
                draggedColId = null;
                targetId = null;
            }






            function clearSelection() {
                const headers = table.querySelectorAll('th');
                headers.forEach(header => header.classList.remove('selected'));

                const cells = table.querySelectorAll('td');
                cells.forEach(cell => cell.classList.remove('highlight'));
            }

            function selectCells(startCol, startRow, endCol, endRow) {
                for (let row = startRow; row <= endRow; row++) {
                    const cell = table.rows[row].cells[startCol];
                    if (cell) {
                        cell.classList.add('highlight');
                    }
                }
            }
        }



        document.addEventListener('DOMContentLoaded', function () {
    const createResizableColumn = function (col, resizer) {
        let x = 0;
        let w = 0;

        const mouseDownHandler = function (e) {
            x = e.clientX;
            const styles = window.getComputedStyle(col);
            w = parseInt(styles.width, 10);
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            resizer.classList.add('resizing');
        };

        const mouseMoveHandler = function (e) {
            const dx = e.clientX - x;
            col.style.width = `${w + dx}px`;
        };

        const mouseUpHandler = function () {
            resizer.classList.remove('resizing');
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
        };

        resizer.addEventListener('mousedown', mouseDownHandler);
    };

    const makeTableResizable = function (table) {
        const cols = table.querySelectorAll('th');
        cols.forEach(function (col) {
            const resizer = col.querySelector('.resizer');
            if (resizer) {
                resizer.style.height = `${table.offsetHeight}px`;
                createResizableColumn(col, resizer);
            }
        });
    };














    
    // Initialize table resizing
    const table = document.getElementById('dynamicTable');
    if (table) {
        makeTableResizable(table);
    } else {
        console.error('Table with ID "dynamicTable" not found');
    }
});





        makeColumnsDraggable();
    </script>







</body>

</html>